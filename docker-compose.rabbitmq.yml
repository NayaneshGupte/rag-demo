# Docker Compose for RabbitMQ Message Queue
# Simple, production-ready RabbitMQ setup with management UI

version: '3.8'

services:
  # ============================================================
  # RABBITMQ SERVER (with Management Plugin)
  # ============================================================

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq-server
    hostname: rabbitmq
    ports:
      - "5672:5672" # AMQP protocol
      - "15672:15672" # Management UI
    environment:
      # Default credentials (change in production!)
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123

      # Server configuration
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: -rabbit log_levels [{connection,error},{default,info}]

      # Enable management plugin
      RABBITMQ_PLUGINS: rabbitmq_management rabbitmq_prometheus

    volumes:
      # Persist RabbitMQ data
      - rabbitmq-data:/var/lib/rabbitmq
      # Custom configuration (optional)
      # - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      # - ./definitions.json:/etc/rabbitmq/definitions.json

    networks:
      - rag-network

    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5

    restart: unless-stopped

  # ============================================================
  # REDIS (for caching and rate limiting)
  # ============================================================

  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - rag-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# ============================================================
# VOLUMES (persist data across restarts)
# ============================================================

volumes:
  rabbitmq-data:
    driver: local
  redis-data:
    driver: local

# ============================================================
# NETWORKS
# ============================================================

networks:
  rag-network:
    driver: bridge
